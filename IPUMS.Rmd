---
title: "IPUMS & R"
author: "Bach Tran"
date: "`r Sys.Date()`"
output: html_document
---

```{r technical setup, include=T, echo = T, warning = FALSE, message = FALSE}
library("ipumsr")
library("dplyr")
library("ggplot2")
library("stringr")
library("purrr")
library("sf")

#html
library("DT")
library("htmltools")
library("shiny")
library("rstudioapi")

#fonts
library("showtext")

#model packages
```

```{r visual setup, include=T, echo = T}
#font
font = font_add_google("Pathway Gothic One", "Pathway Gothic One")
font1 = "Pathway Gothic One"
showtext_auto()

#palette . I will add after I figure out the aesthetic I like
palette = c("#011638","#23CE6B", "#FF8811","#800000","#305CDE", "#798086")

#ggplot. I will add after I figure out the aesthetic I like
##ggplot scale_color
scale_color =  scale_color_manual(values= palette)
scale_fill = scale_fill_manual(values= palette)

##ggplot theme
theme = theme(panel.grid.major = element_blank(), #graph element
          panel.grid.minor = element_blank(),
          panel.background = element_rect(fill = '#FFF8F0'),
          plot.background = element_rect(fill = '#FFF8F0'), 
          axis.line = element_line(colour = "black")) +
        theme(text=element_text(size=20,  family= font1),
             (legend.position="bottom")) #I split the function into two for readability

```

### Import Data and Codebook <br>

```{r setup, include=T, echo = T}
ddi = read_ipums_ddi("usa_00012.xml")
dta_all = read_ipums_micro(ddi)
```
#### Data citation: Steven Ruggles, Sarah Flood, Matthew Sobek, Daniel Backman, Grace Cooper, Julia A. Rivera Drew, Stephanie Richards, Renae Rodgers, Jonathan Schroeder, and Kari C.W. Williams. IPUMS USA: Version 16.0 [dataset]. Minneapolis, MN: IPUMS, 2025. https://doi.org/10.18128/D010.V16.0 <br>


### On the data subset: _[forthcoming]_ <br>

### Analysis objective: _[forthcoming]_ <br>

### Data Exploration
```{r explore, echo=T}
names(ddi)
ipums_view(ddi,"codebook.html", launch = FALSE)
```
### Data wrangle (I will add more as time progresses)
```{r subset, echo=T}
college_regex = "^[123] yeear(s)? of college$" #define patern to relabel some college
dta_all$EDUCD_level = dta_all$EDUCD %>%
  lbl_collapse(~.val %/% 10)%>%
  lbl_relabel(
    lbl(2,"Less than High School") ~.val> 0 & .val <6,
    lbl(3, "High school") ~.lbl =="Grade 12",
    lbl(4, "Some college") ~str_detect(.lbl, college_regex),
    lbl(5, "College or more") ~.val %in% c(10,11)
  )%>%
  as_factor()
```


##Data Exploration pt.2 <br>
```{r wrangle, echo=T}
college_to_advance_degree_graph = dta_all %>%
  group_by(YEAR)%>%
  filter(AGE >=25 & AGE <= 67) #Assuming retirement age is 67 

more_than_four_college_year_to_population_age_25_to_67 = college_to_advance_degree_graph%>% #long name, sorry, but Im open to suggestions for a better naming schemes
  summarise("prop" = 
              sum(EDUCD_level == "College or more") / length(EDUCD_level) ) %>%
  mutate(percent = signif(prop*100, digits = 4))
```

## Education Attainment v. various factors <br>
### Composition of people with more than 4 years of college to population from 25-67 <br>
``` {r overview graph, echo = T}
ggplot(more_than_four_college_year_to_population_age_25_to_67, aes(YEAR, percent)) +
  geom_point(color = "#011638") +
  geom_line(color = "#011638") +
  ylim(30,40) +
  scale_x_continuous(breaks = 2017:2023) +
  labs(
    x ="Year",
    y = "Percentage with a Bachlor Degree and above",
    title = "Proportion of people with a college degree among the the 25 to 67 years old",
    subtitle = paste0("Data source: ", ddi$ipums_project),
    caption = paste(
      strwrap(ipums_var_desc(ddi, EDUCD),120),
      collapse ="\n")) +
  geom_text(aes(label = paste(percent,"%"), family = font1,vjust = -0.5)) +
  theme
```
#### Composition of people with more than 4 years of college to population from 25-67 <br>
#bachelor and above are costly (for both the seekers and the institution that trains them, but does it really worth it?) <br>
``` {r overview graph 2, echo = T}
base_degree_post_secondary_excl_aa = dta_all %>% #qty of post degree excl. AA 
  select(YEAR, AGE, EDUCD) %>%
  filter(AGE >=25 & AGE <= 67) %>% #Assuming retirement age is 67 
  filter(EDUCD %in% c(101, 114:116))

#function to calculate the proportion of each degree excl. AA 
percent_degree_post_secondary_excl_aa_each_year = function(year) {
    base_degree_post_secondary_excl_aa %>%
        filter(YEAR == year) %>%
        group_by(YEAR,EDUCD) %>%
        summarise(quantity = n())%>%
        mutate(frequency = quantity/sum(quantity)) %>%
        mutate(percentage = signif(frequency*100, digits = 4))%>%
        as_factor()
}

#df each year
high_edu_prop18 = percent_degree_post_secondary_excl_aa_each_year(2018)
high_edu_prop19 = percent_degree_post_secondary_excl_aa_each_year(2019)
high_edu_prop20 = percent_degree_post_secondary_excl_aa_each_year(2020)
high_edu_prop21 = percent_degree_post_secondary_excl_aa_each_year(2021)
high_edu_prop22 = percent_degree_post_secondary_excl_aa_each_year(2022)
high_edu_prop23 = percent_degree_post_secondary_excl_aa_each_year(2023)

#over the year composition
high_edu_prop_all = rbind(high_edu_prop18,high_edu_prop19,high_edu_prop20,high_edu_prop21,high_edu_prop22,high_edu_prop23) %>%
  as_factor()
```


``` {r overview graph , echo = T}
#plot
ggplot(high_edu_prop_all, aes(YEAR, percentage, color= EDUCD)) +
  geom_line() + 
  geom_point() +
  scale_color +
  scale_fill +
  labs(
    x ="Year",
    y = "% Degree-holders",
    color = "Education Level",
    title = "Highest degree completed among post-secondary degree holders",
    subtitle = paste0("Respondents age 22-67 excluding AA degree-holders. Data source: ", ddi$ipums_project),
    caption = paste(
      strwrap(ipums_var_desc(ddi, EDUCD),120),
      collapse ="\n")) +
  geom_text(aes(label = paste(percentage,"%"), family = font1,vjust = -0.5)) +
  theme(legend.position = "bottom")  +
  theme 
```


``` {r college vs no college among working pop, echo = T}
#plot
college_to_non_college = dta_all%>%
  filter(AGE >=25 & AGE <= 67)


college_to_non_college$EDUCD_classifier = college_to_non_college$EDUCD %>% #re-factor and re-label EDUCD where 1 = less the Bachelor, 2 = Bachelor & above
  lbl_collapse(~ ifelse(.val %in% 0:100, 1, 
                        ifelse(.val > 100 & .val < 999, 2, 999))) %>%
  lbl_relabel(
        lbl(1,"Less than a Bachelor Degree")~.val ==1,
        lbl(2,"Bachelor Degree or more")~.val ==2
        )%>%
  as_factor()
college_to_non_college_str_sum = college_to_non_college %>%
  select(YEAR, EDUCD_classifier) %>%
  group_by(YEAR, EDUCD_classifier)%>%
  summarise(count = n())%>%
  print()

#data viz of total sample 2018-2023
ggplot(college_to_non_college_str_sum, aes(x = YEAR, y = count, fill = EDUCD_classifier)) +
  geom_bar(stat="identity") + 
  geom_text(aes(label = count, vjust = -1, fill = "white")) +
  scale_x_continuous(breaks = 2017:2023) +
  labs(
    x ="Year",
    y = "Total people in the sample",
    title = "Quantity of people between the age of 25 to 67 years old in the in sample") +
  theme +
  scale_fill

```

``` {r college vs income data graphs, echo = T}
#plot
college_to_non_college = dta_all %>%
  filter(AGE >=25 & AGE <= 67)

college_to_non_college$EDUCD_classifier = college_to_non_college$EDUCD %>% #re-factor and re-label EDUCD where 1 = less the Bachelor, 2 = Bachelor & above
  lbl_collapse(~ ifelse(.val %in% 0:100, 1, 
                        ifelse(.val > 100 & .val < 999, 2, 999))) %>%
  lbl_relabel(
        lbl(1,"Less than a Bachelor Degree")~.val ==1,
        lbl(2,"Bachelor Degree or more")~.val ==2
        )%>%
  as_factor()

```
#**_________________________________PLEASE DISREGARD ALL CODE BELLOW THIS LINE (FOR NOW)_________________________________** <br>